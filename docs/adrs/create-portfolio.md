# Товар

## Status

Предложение

</br>

---

## Context

Необходимо реализовать функционал просмотра инвестором баланса портфеля.
[Требования](https://docs.google.com/document/d/1DUFQN1GRy39zRMPpAQzdSCkU6NQ3lBxFG0v48o7sHt8/edit#) </br>
Необходимо реализовать функционал внесения инвестором товара в свой портфель.
[Требования](https://docs.google.com/document/d/1SDawYYFYIkpX-kCsV7bpX1GtRMHevSZascpFvy37QTM/edit#heading=h.2snfcrwzlkcf)

[схема](#) {на данный момент в репозитории нет источника}

</br>

---

## Decision

### Новый микросервис

Создание нового микросервиса, отвечающего за работу с портфелем, в частности получение баланса портфеля и внесение товара в свой портфель.  
Сервис будет объединять в себе Commands и Queries.

</br>

---

### Реализация нового сервиса

*На данном этапе будут реализованы два метода: метод чтения баланса портфеля и метод внесения инвестором товара в свой портфель.*

</br>

#### **Чтение**

Клиент отправляет запрос на получение баланса портфеля, фасад принимает запрос, из meta-данных достает токен, а из токена id и отправляет его на микросервис портфеля и товара.
Сервисы портфеля и товара принимают данный запрос, после чего агригируется ответ (на фасаде):

  - из сервиса портфеля
    - id продутка
    - volume - количество товара
    - spent - сколько потратил инвестор на продукт
    - earned - сколько заработал на продукте
  - из сервиса товаров
    - name - имя продукта
    - best_ask - Текущая цена
  - расчёт 
    - estimate - Стоимость всего объема товара
    - delta_abs - Дельта по всему объему  (абсолютное значение)
    - delta_rel  - Дельта по всему объему  (относительное значение)

Далее происходит отправка с фасада клиенту.

</br>

#### **Внесение**

Клиент отправляет запрос на добавление товара в портфель, фасад принимает запрос: 

- name - имя товара
- volume - количество товара
- start_price - стартовая цена 
  
Далее формируется запрос на микросервис товара:

- id (из токена) - пользователя
- name - имя товара
- volume - количество товара
- start_price - стартовая цена 

После чего происходит отправка этого запроса на сервис товаров, где происходит проверка на существование данного товара и отправляется сообщение в *кафку* на *сервис портфеля*. Далее происходит запись товара в портфель. Клиенту отправляется сообщение - *Товар внесён в портфель*

</br>

---

## Фасад

*Также будет реализован метод в фасаде для отправки запроса на получения баланса портфеля и внесения товара в свой портфель.*

</br>

### Общение фасада и portfolio-service'а

Общение между фасадом и микросервисом будет осуществляться по протоколу grpc.

</br>

### Предлагаемые proto-файлы

*Данные запросы с фасада на получение портфеля и на добавление продукта.*

```protobuf
service PortfolioService {
	rpc GetPortfolio(GetPortfolioRequest) returns (GetPortfolioResponse);
	rpc AddProduct(AddProductRequest) returns (AddProductResponse); 
}


message GetPortfolioRequest {
	string id = 1;
}

message ChangePortfolioRequest {
    string id = 1;
	  string name = 2;
	  double volume = 3;
    double start_price = 4;
}

message PortfolioResponse {
    message Product {
        string id = 1;
        string name = 2 
        int32 volume = 3; 
        double spent = 4;
        double earned = 5;
        double best_ask = 6;
        double estimate = 7;
        double delta_abs = 8;
        double delta_rel = 9;
    }

    message Total {
        double spent = 1;
        double earned = 2;
        double estimate = 3;
        double delta_abs = 4;
        double delta_rel = 5;
    }

    repeated Product products = 1;
    Total total = 2;
}
```

</br>

---

## Идемпотентность

Проблема идемпотентности будет решена на фасаде ключом идемпотентности. Клиент будет передавать некий ключ уникальности запроса. Таким образом, серверу по этому ключу нужно определить, обрабатывался ли этот запрос ранее. Если нет (новый запрос), обрабатываем и сохраняем результат обработки, да (повторный запрос) - загружаем результат и возвращаем его без обработки, после возвращения, будет генерироваться новый уникальный ключ на клиенте/фасаде.

</br>

---

## Кафка

- **Регистрация нового пользователя** </br>
  Сервис аутентификации пишет в топик *Auth_Register* **Id** нового пользователя, сервис портфеля считывает **Id** и создаёт пустую запись.

- **Заморозка продукта пользователя** </br>
  Сервис заявок пишет в топик *Order_Created* информацию о новой заявке, сервис портфеля получает поля *Id пользователя*, *Id товара* и *количество товара*. После чего замораживает его. Далее отправка сообщения в топик *Orders_Validation* о статусе валидации *(свалидирована или же нет)*.

- **Исполнение транзакции** </br>
  Сервис заявок пишет в топик *Order_Execute* информацию о исполненой транзаакции, сервис портфеля получает *Id продавца*, *Id покупателя*, *Id товара*, *количество товара*. После чего исполняет сделку.

</br>

---

## Consequences

1. Повторение запросов на фасад и на сервис
2. Для получения баланса портфеля и внесения товара в свой портфель имеется отдельный сервис
3. Тесная связь фасада с сервисом
4. Необходимо реализовать получение *имени товара* и *best_ask* по *id* на **сервисе товаров**
5. Необходимо реализовать добавление товара по *имени* на **сервисе товаров**
