# ADR

# Demo-счёт

</br>

## Статус

Предложение


---

## Контекст

Отправка инвестором запроса на получение информации по своему счёту.

Пополнение Счета Инвестора.


---
## Решение

Добавить id пользователя в сообщения от фасада к сервису, чтобы работать с данными конкретного инвестора.

Вывод данных по счёту - только сумма.

Архитектура
Создание микросервиса баланса с использованием шаблонов. </br>
[Identity и простой шаблоны](https://github.com/Calabonga/Microservice-Template/tree/master/AspNetCore%20v6.0/MinimalAPI) </br>
[Требования по просмотру инвестором общей информации об аккаунте](https://docs.google.com/document/d/1pgPy82yXRVCNzg4vHvQDOScUsdKRvdsGnhQccSYnDl0/edit#heading=h.tikuacsydbsn) </br>
[Требования по пополнению счета инвестора](https://docs.google.com/document/d/1x8DXZh9CsJeGgLQX6pNTtrdc-CaqekNFoPI4aqc9nr4/edit)

**Добавление пользователя в базу двнных.** </br>
При регистрации нового пользователя, сервис регистрации отправляет об этом сообщение, которое содержит id пользователя в кафку, сервис баланса получает его и добавляет новую запись в базу данных.

**Общение фасада и сервиса.** </br>
Фасад отправляет токен в аутентификационный сервис на проверку подлинности. Фасад отправляет запрос по grpc на микросервис баланса, затем микросервис баланса получает запрос, обрабатывает его и отправляет ответ в топик ("balance-response"), далее возрат информации на микросервис для сохранения данных, ответ об успешности операции идет на фасад.

**Отправка инвестором запроса на получение информации по своему счёту.** </br>
Фасад отправляет токен в аутентификационный сервис на проверку подлинности. При подтвержении токена фасад достаёт из него id и по grpc отправляет его на микросервис. Микросервис баланса получает запрос и возвращает баланс пользователя.

Если пользователь отсутствует в базе данных, то сервис отправляет Ошибку.

**Пополнение Счета Инвестора.** </br>
Фасад отправляет токен в аутентификационный сервис на проверку подлинности. При подтвержении токена фасад отправляет сообщение {id, сумма_пополнения} на микросервис баланса.
Микросервис баланса получает запрос и ищет id инвестора в бд, если нет в таблице информации о балансе, то вносится новая запись с данной суммой, если же есть информация, то происходит update. Далее отправляется информация об общей сумме инвестора на счету по grpc в фасад. После чего возвращается ответ на клиент.

**Списание со счёта инвестора** </br>
Фасад отправляет токен в аутентификационный сервис на проверку подлинности. При подтвержении токена фасад отправляет сообщение {id, сумма_списания} на микросервис баланса.
Сервис проверяет достаточность денег на счёте:

- Если достаточно, то сервис отправляет обратно сообщение об успешность операции, в которое входит и итоговый баланс.
- Если не достаточно, то сервис отправляет сообщение об ошибке.


---
## Идемпотентность

Проблема *идемпотентности* будет решена на фасаде.

---

## Кафка

- **Заморозка баланса** </br>
  (Сервис баланса имеет два поля - **active_balance and frozen_balance**. </br>
  *active_balance* - баланс, доступный для формирования заявок, </br>
  *frozen_balance* - баланс, который уже зафиксирован какими-то заявками) 

  Сервис заявок создает новую заявку и записывает данные по ней в топик *Orders_Create*, после чего сервис баланса получает *сумму* и *id_покупателя* созданной заявки, записывает сумму в *frozen_balance* и вычитает это значение из *active_balance* данного покупателя.

- **Списывание из замороженных активов** </br>
  После того как заявка исполнена, сервис заявок записывает в топик *Orders_Executed* все данные по совершенной транзакции, сервис баланса считывает *Id_продавца*, *Id_покупателя*, *сумму*.
  По Id_покупателя списывается сумма с frozen_balance.
  По Id_продавца добавляется сумма в active_balance.
  
---

## Последствия

Не нужно будет работать со всеми данными из бд, а только с данными конкретного инвестора.

Простое получение нужной информации.
