# ADR

# Demo-счёт

</br>

## Статус

Предложение

</br>

## Контекст

Отправка инвестором запроса на получение информации по своему счёту.

Пополнение Счета Инвестора.

</br>

## Решение

Добавить логин в запросы, чтобы работать с данными конкретного инвестора.

Вывод данных по счёту - только сумма.

Архитектура
Создание микросервиса баланса с использованием шаблонов.
[Identity и простой шаблоны](https://github.com/Calabonga/Microservice-Template/tree/master/AspNetCore%20v6.0/MinimalAPI)

**Общение фасада и сервиса.** </br>
Фасад отправляет токен в аутентификационный сервис на проверку подлинности. Фасад отправляет запрос по grpc на микросервис баланса, затем микросервис баланса получает запрос, обрабатывает его и отправляет ответ в топик ("balance-response"), далее возрат информации на микросервис для сохранения данных, ответ об успешности операции идет на фасад.
Еще каким образом будет происходит баланс сообщений между репликами?

**Отправка инвестором запроса на получение информации по своему счёту.** </br>
Фасад отправляет токен в аутентификационный сервис на проверку подлинности. При подтвержении токена фасад достаёт из него id и по grpc отправляет его на микросервис. Микросервис баланса получает запрос и ищет данные по id в кеше:

- если данных в кеше нет, то по полученному id в бд происходит поиск данных счёта и возвращается как сам баланс, так и id-пользоветеля. Вывод id необдодим для сопоставления запроса и ответа.
- если данные в кеше есть, то они берутся из него.

</br>

Обновление данных в кеше просходит таким образом - кеш просматривает топик ("balance-response-update") на обновление баланса по id:

- если id имеется в кеше, то операция применяется и в нём.
- если id нет в кеше, то операция игнорируется.

Если пользователь отсутствует в базе данных, то сервис отправляет "0".
**Пополнение Счета Инвестора.** </br>
Фасад отправляет токен в аутентификационный сервис на проверку подлинности. При подтвержении токена фасад отправляет сообщение {id, сумма_пополнения} на микросервис баланса.
Микросервис баланса получает запрос и ищет id инвестора в бд, если нет в таблице информации о балансе, то вносится новая запись с данной суммой, если же есть информация, то происходит update. Далее отправляется информация об общей сумме инвестора на счету по grpc в фасад. После чего возвращается ответ на клиент.

</br>

## Последствия

Не нужно будет работать со всеми данными из бд, а только с данными конкретного инвестора.

Простое получение нужной информации.
