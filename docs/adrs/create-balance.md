# ADR

# Demo-счёт

</br>

## Статус

Предложение

</br>

## Контекст

Отправка инвестором запроса на получение информации по своему счёту.

Пополнение Счета Инвестора.

</br>

## Решение

Добавить id пользователя в сообщения от фасада к сервису, чтобы работать с данными конкретного инвестора.

Вывод данных по счёту - только сумма.

Архитектура
Создание микросервиса баланса с использованием шаблонов.
[Identity и простой шаблоны](https://github.com/Calabonga/Microservice-Template/tree/master/AspNetCore%20v6.0/MinimalAPI)

**Добавление пользователя в базу двнных.** </br>
При регистрации нового пользователя, сервис регистрации отправляет об этом сообщение, которое содержит id пользователя в кафку, сервис баланса получает его и добавляет новую запись в базу данных.

**Общение фасада и сервиса.** </br>
Фасад отправляет токен в аутентификационный сервис на проверку подлинности. Фасад отправляет запрос по grpc на микросервис баланса, затем микросервис баланса получает запрос, обрабатывает его и отправляет ответ в топик ("balance-response"), далее возрат информации на микросервис для сохранения данных, ответ об успешности операции идет на фасад.

**Отправка инвестором запроса на получение информации по своему счёту.** </br>
Фасад отправляет токен в аутентификационный сервис на проверку подлинности. При подтвержении токена фасад достаёт из него id и по grpc отправляет его на микросервис. Микросервис баланса получает запрос и возвращает баланс пользователя.

Если пользователь отсутствует в базе данных, то сервис отправляет Ошибку.

**Пополнение Счета Инвестора.** </br>
Фасад отправляет токен в аутентификационный сервис на проверку подлинности. При подтвержении токена фасад отправляет сообщение {id, сумма_пополнения} на микросервис баланса.
Микросервис баланса получает запрос и ищет id инвестора в бд, если нет в таблице информации о балансе, то вносится новая запись с данной суммой, если же есть информация, то происходит update. Далее отправляется информация об общей сумме инвестора на счету по grpc в фасад. После чего возвращается ответ на клиент.

**Списание со счёта инвестора** </br>
Фасад отправляет токен в аутентификационный сервис на проверку подлинности. При подтвержении токена фасад отправляет сообщение {id, сумма_списания} на микросервис баланса.
Сервис проверяет достаточность денег на счёте:

- Если достаточно, то сервис отправляет обратно сообщение об успешность операции, в которое входит и итоговый баланс.
- Если не достаточно, то сервис отправляет сообщение об ошибке.

</br>

## Идемпотентность

Клиент будет передавать некий ключ уникальности запроса. Таким образом, серверу по этому ключу нужно определить, обрабатывался ли этот запрос ранее. Если нет (новый запрос), обрабатываем и сохраняем результат обработки, да (повторный запрос) - загружаем результат и возвращаем его без обработки.

## Последствия

Не нужно будет работать со всеми данными из бд, а только с данными конкретного инвестора.

Простое получение нужной информации.
